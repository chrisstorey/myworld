# Software Description

The "myworld" software is designed to generate synthetic data simulating households and individuals. This data can be used for various purposes, such as testing applications, populating databases for development, or creating anonymized datasets for analysis.

## Current Capabilities

- **Household Data Generation:** The software can generate detailed household data, including:
    - Postcode
    - Geographical coordinates (latitude and longitude)
    - Administrative region identifiers
    - Household type
    - Counts of occupants: adults, children, and individuals over 65.
- **Individual Person Data Generation:** The software can generate data for individual people, including:
    - Full names
    - Date of birth
    - Age
    - Nationality
    - Gender

## Technologies Used

- **Programming Language:** Python
- **Data Generation:** Faker library
- **Database Interaction:** Pony ORM
- **Database Systems:** PostgreSQL (used with Pony ORM in `main.py`) and SQLite (potentially used in `make_household.py` and `make_people.py` via `sql_helpers.py` and pandas).

## Key Scripts

- `main.py`: Appears to be the main script for orchestrating data generation and interacting with the database using Pony ORM (PostgreSQL).
- `make_household.py`: Script responsible for generating household-level data.
- `make_people.py`: Script responsible for generating individual person-level data.

# Areas for Improvement

## Current Challenges

- **Database System Inconsistency:** There's an apparent inconsistency in database usage. `main.py` is configured to use Pony ORM with a PostgreSQL database. However, `make_household.py` and `make_people.py` seem to interact with an SQLite database through `sql_helpers.py` and the pandas library. This can lead to data silos and difficulties in maintaining a unified data view.
- **Disconnected Data Flow:** The data generated by `make_household.py` (households) and `make_people.py` (individuals) is not clearly or consistently linked with the database entities defined in `main.py` using Pony ORM. For instance, while `main.py` defines `Person` and `Household` entities, the process for populating these entities with data from the other scripts is not straightforward. The person generation loop within `main.py` also seems to operate somewhat independently of the data generated by `make_people.py`. This makes it difficult to ensure data integrity and relationships between households and individuals within the primary PostgreSQL database.

# Defining a 'Complete Household'

A "complete household" in the "myworld" project represents a fully simulated living unit with all its members. This includes:

- **Unique Household Identifier:** A distinct ID that uniquely identifies the household within the database.
- **Accurate Address Information:** Comprehensive and correct address details, leveraging existing capabilities such as postcode, precise geographical coordinates (latitude/longitude), and administrative district codes (e.g., LAUS code, NUTS codes).
- **Clearly Defined Household Type:** The household composition must be explicitly stated, referencing the predefined types available in `household/__init__.py` (e.g., "Married couple, two children", "Single parent, one child", "Elderly couple").
- **Comprehensive List of Individuals:** All individuals residing in that household must be generated and linked. Each person should have their attributes correctly characterized (age, gender, name) according to their role within the household type (e.g., if the household type is "Married couple, two children", there should be two adults with appropriate marital status indicators and two children).

# User Stories for Achieving Complete Households

- As a data consumer, I want household data to be stored consistently in a PostgreSQL database so that I can reliably query and join household and person information.
- As a developer, I want `make_household.py` to write its output to the PostgreSQL `Household` table using the Pony ORM, so that data is centralized and aligns with the defined schema.
- As a data consumer, I want `make_people.py` to read household compositions from the PostgreSQL `Household` table and generate all specified individuals (e.g., adults by gender, children, over-65s) for each household, accurately reflecting the household type.
- As a data consumer, I want individuals within a household to have accurate attributes, including age group (child, adult, over-65), gender, and correctly assigned last names (e.g., for married individuals and their children).
- As a developer, I want the `Person` entities generated by `make_people.py` to be correctly linked to their respective `Household` entity in PostgreSQL using ORM relationships.
- As a developer, I want to clarify the role of `main.py`'s person generation loop and integrate its logic or remove it to prevent data conflicts or inconsistencies with the `make_people.py` process.

# Recommended Improvements

1.  **Unify Database System:**
    *   **Decision:** Standardize on PostgreSQL as the single, authoritative database for the "myworld" project.
    *   **Action:** Refactor `make_household.py`, `make_people.py`, and any parts of `sql_helpers.py` that are retained for database interaction. These components must be modified to use Pony ORM for all database operations, ensuring they communicate with the PostgreSQL instance configured in `main.py` (or a shared database configuration module).

2.  **Refactor `make_household.py`:**
    *   **ORM Integration:** Modify the script to utilize the `Household` Pony ORM entity (this entity might need to be defined in a shared models file accessible by all scripts, rather than just `main.py`).
    *   **Field Population:** Ensure the script populates all necessary fields of the `Household` entity:
        *   A unique identifier (Pony ORM can auto-generate primary keys, or `uuid.uuid4()` can be used if a specific format is needed before insertion).
        *   Postcode and all associated fetched address details (longitude, latitude, LAUS code, NUTS codes, etc.).
        *   The specific household type string (e.g., "Couple with two children") as determined by `household.household()`.
        *   Accurate demographic counts: `adults_total`, `adults_over65`, `adult_male`, `adult_female`, `children_total`, `non_dependents` (and any other relevant counts like `married` status) based on its internal logic and the selected household type.
    *   **Data Persistence:** All generated household data should be committed to the PostgreSQL database using Pony ORM's session management (e.g., within a `db_session`).

3.  **Refactor `make_people.py`:**
    *   **Data Source:** The script must query the PostgreSQL `Household` table (using Pony ORM) to retrieve household records and their compositions (e.g., number of adults, children, household type).
    *   **Person Entity Creation Logic:** Implement comprehensive logic to create `Person` ORM entities for each household member:
        *   Generate the correct number of male and female adults based on the `adult_male` and `adult_female` fields (or derived from `adults_total` and gender assignment logic) from the queried `Household` entity.
        *   Generate the specified number of children (`children_total`), assigning appropriate ages (e.g., using `people.age.dob_under18()`) and linking them to their household.
        *   Generate individuals over 65 years of age (`adults_over65`), ensuring their ages are appropriate.
        *   Implement a robust system for assigning last names. This should consider the `married` status from the `Household` entity (e.g., spouses share a last name) and how children's last names are derived (e.g., typically from one or both parents).
        *   All generated `Person` entities must be correctly associated with their parent `Household` entity using Pony ORM's relationship features (e.g., `household_object.persons.add(new_person_object)` if `persons` is a `Set` in the `Household` entity).
    *   **Data Persistence:** New `Person` objects should be committed to PostgreSQL using Pony ORM sessions.

4.  **Reconcile `main.py` Person Generation Loop:**
    *   **Analysis:** The existing person generation loop in `main.py` needs to be carefully analyzed to understand its current functionality and how it interacts (or conflicts) with the proposed flow.
    *   **Decision Path:**
        *   **Option A: Remove/Disable:** If `make_people.py` is enhanced to become the sole, definitive script for populating households with individuals based on data from `make_household.py`, then the loop in `main.py` might be redundant and should be removed or disabled to prevent data duplication or inconsistencies.
        *   **Option B: Integrate/Clarify:** If the loop serves a distinct, necessary purpose (e.g., generating individuals not associated with the detailed households from `make_household.py`, or perhaps for a different simulation aspect), its role must be clearly defined. Ensure its output is consistent with the main data model, does not conflict with the primary household generation flow, and that any generated persons are appropriately categorized or linked if necessary.
    *   **Goal:** The primary objective is to avoid orphaned person records, conflicting data, or unclear data origins.

5.  **Ensure Data Integrity and Relationships:**
    *   **ORM Power:** Emphasize the use of Pony ORM's capabilities to define and enforce relationships between entities, particularly the one-to-many relationship between `Household` (one) and `Person` (many).
    *   **Database Schema:** This involves correctly defining primary keys in each entity and foreign keys in the `Person` entity (linking back to `Household`) through the ORM models. Pony ORM will then manage the underlying SQL schema to maintain referential integrity.
